name: Create and publish a Docker image


on:
  pull_request:
    types: [opened, ready_for_review]
  push:
    branches:
      - '*'
    tags:
      - "v*.*.*"

env:
  PHP_VERSION: "8.0"
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  extensions: "xml mbstring curl openssl dom gd zip intl json intl"
  composer-install-args: "--no-progress --no-interaction --prefer-dist --no-scripts"

jobs:
  composer:
    name: "Download composer"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: shivammathur/setup-php@v2
        with:
          extensions: "${{ env.extensions }}"
          php-version: ${{ env.PHP_VERSION }}
          coverage: none
      - name: Check if composer.json exists
        id: check_files
        uses: andstor/file-existence-action@v1
        with:
          files: 'composer.json'
      - uses: actions/cache@v2
        with:
          path: vendor
          key: ${{ runner.os }}-${{ hashFiles('composer.lock') }}

      - uses: php-actions/composer@v6
        with:
          php_extensions: "${{ env.extensions }}"
          php_version: ${{ env.PHP_VERSION }}
          args: "${{ env.composer-install-args }}"

  node:
    name: "Install node public"
    runs-on: "ubuntu-latest"
    needs: composer

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v3
        with:
          node-version: 14
          cache: 'yarn'
      - run: yarn install
      - run: yarn encore production
      - uses: actions/cache@v2
        with:
          path: public/build
          key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}

  qa:
    name: "Quality assurance"
    runs-on: "ubuntu-latest"
    needs: [composer, node]

    steps:
      - uses: actions/checkout@v2
      - uses: shivammathur/setup-php@v2
        with:
          extensions: "${{ env.extensions }}"
          php-version: ${{ env.PHP_VERSION }}
          coverage: none
      - uses: actions/cache@v2
        with:
          path: vendor
          key: ${{ runner.os }}-${{ hashFiles('composer.lock') }}
      - run: composer ecs

  static-analysis:
    name: "Static analysis"
    runs-on: "ubuntu-latest"
    needs: [composer, node]

    steps:
      - uses: actions/checkout@v2
      - uses: shivammathur/setup-php@v2
        with:
          extensions: "${{ env.extensions }}"
          php-version: ${{ env.PHP_VERSION }}
          coverage: none

      - uses: actions/cache@v2
        with:
          path: vendor
          key: ${{ runner.os }}-${{ hashFiles('composer.lock') }}

      - run: composer phpstan

  rector:
    name: "Rector"
    runs-on: "ubuntu-latest"
    needs: [composer, node]

    steps:
      - uses: actions/checkout@v2
      - uses: shivammathur/setup-php@v2
        with:
          extensions: "${{ env.extensions }}"
          php-version: ${{ env.PHP_VERSION }}
          coverage: none

      - uses: actions/cache@v2
        with:
          path: vendor
          key: ${{ runner.os }}-${{ hashFiles('composer.lock') }}

      - run: composer rector

  build:
    name: "Build artifact"
    runs-on: "ubuntu-latest"
    needs: [qa, static-analysis, rector]
    steps:
      - uses: actions/checkout@v2
      - uses: actions/cache@v2
        with:
          path: vendor
          key: ${{ runner.os }}-${{ hashFiles('composer.lock') }}
      - uses: actions/cache@v2
        with:
          path: public/build
          key: ${{ runner.os }}-${{ hashFiles('yarn.lock') }}
      - name: Zip artifact for deployment
        run: zip -r release.zip src config bin var migrations vendor queue public

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v2
        with:
          name: php-app
          path: release.zip
